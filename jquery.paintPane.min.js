(function(e){e.support.canvas=(document.createElement("canvas")).getContext;e.fn.paintPane=function(n,p){function k(){if(!e.support.canvas){e(this).html("Browser does not support HTML5 canvas, please upgrade to a more modern browser.");return false}return e.proxy(m,this)()}function m(){var q=e.data(this,"paintPane");if(!q){q=new c(this,e.extend(true,{},n));e.data(this,"paintPane",q)}return q}function j(){var q=e.data(this,"paintPane");if(q){if(q[n]){q[n].apply(q,[p])}else{if(p!==undefined){if(q[o]){q[o].apply(q,[p])}if(q.options[n]){q.options[n]=p}}else{if(q[o]){l.push(q[o].apply(q,[p]))}else{if(q.options[n]){l.push(q.options[n])}else{l.push(undefined)}}}}}}if(typeof n==="string"){var l=[],o=(p?"set":"get")+n.charAt(0).toUpperCase()+n.substring(1);this.each(j);if(l.length){return l.length===1?l[0]:l}return this}n=e.extend({},e.fn.paintPane.defaults,n);n.lineWidth=parseInt(n.lineWidth,10);n.fontSize=parseInt(n.fontSize,10);return this.each(k)};e.fn.paintPane.extend=function(k,j){var m;function l(p){if(j[p]){var o=c.prototype[p],n=k[p];j[p]=function(){o.apply(this,arguments);n.apply(this,arguments)}}else{j[p]=k[p]}}j=c.prototype;for(m in k){(l)(m)}};e.fn.paintPane.defaults={defaultBrushSize:8,maxBrushSize:50,inkAmount:5,splashRange:75,splashInkSize:10,mode:"pencil",strokeStyle:"#000",bg:"#ffffff",onShapeDown:null,onShapeMove:null,onShapeUp:null};function c(k,j){this.$canvas=this.$el=e(k);this.canvas=k;this.options=j;this.init=false;this.previousMode=null;this.canvas.width=this.width=this.$el.width();this.canvas.height=this.height=this.$el.height();this.context=this.canvas.getContext("2d");if(this.options.mode!="line"){this.brush=new g(this.canvas.width/2,this.canvas.height/2,this.options.defaultBrushSize,this.options.inkAmount,this.options.splashRange,this.options.splashInkSize,this.options.strokeStyle)}this.generate();this._init()}c.prototype={_init:function(){var j=null,k=null;this.init=true;for(j in this.options){k="set"+j.capitalize();if(this[k]){this[k](this.options[j])}}},generate:function(){if(this.init){return this}var n=this;function l(p){var o=(p?p.capitalize():""),r="canvas"+o,q="ctx"+o;n[q]=n[r].getContext("2d");return n["$"+r]}l();this.$canvas.on("mousedown",k).on("mousemove",m);e(document).on("mouseup",j);function k(o){o.preventDefault();o.stopPropagation();n.draw=true;o.canvasEvent="down";n._callShapeFunc.apply(n,[o])}function m(o){if(n.draw){o.canvasEvent="move";n._callShapeFunc.apply(n,[o])}}function j(o){if(n.draw){n.draw=false;o.canvasEvent="up";n._callShapeFunc.apply(n,[o])}}},resize:function(){this.width=this.$el.width();this.height=this.$el.height();this.canvas.width=this.width;this.canvas.height=this.height;this.setBg(bg,true)},setMode:function(j){this.previousMode=this.options.mode;this.options.mode=j},setBg:function(k,j){if(!k){return true}if(k.inspectColor()){this.context.fillStyle=k;this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}},_callShapeFunc:function(m){var k=this.$canvas.offset(),j=m.canvasEvent.capitalize(),l="_draw"+this.options.mode.capitalize()+j;m.pageX=Math.floor(m.pageX-k.left);m.pageY=Math.floor(m.pageY-k.top);if(this[l]){this[l].apply(this,[m])}if(this.options["draw"+j]){this.options["_draw"+j].apply(this,[m])}},_drawInkDown:function(j){this.brush.startStroke(j,this.options);this.brush.inkPaint(this.ctx,j.pageX,j.pageY,this.options)},_drawInkMove:function(j){if(this.draw){this.brush.inkPaint(this.ctx,j.pageX,j.pageY)}},_drawInkUp:function(){this.brush.endStroke()},_drawCrayonDown:function(j){this.brush.crayonPaint(this.ctx,j.pageX,j.pageY,this.options)},_drawCrayonMove:function(j){if(this.draw){this.brush.crayonPaint(this.ctx,j.pageX,j.pageY)}},_drawCrayonUp:function(){this.brush.resetCrayon()},_drawPencilDown:function(j){this.ctx.lineJoin="round";this.ctx.lineCap="round";this.ctx.strokeStyle=this.options.strokeStyle;this.ctx.fillStyle=this.options.strokeStyle;this.ctx.lineWidth=this.options.lineWidth;this.ctx.beginPath();this.ctx.arc(j.pageX,j.pageY,this.options.lineWidth/2,0,2*Math.PI,!0);this.ctx.closePath();this.ctx.fill();this.ctx.beginPath();this.ctx.moveTo(j.pageX,j.pageY)},_drawPencilMove:function(j){this.ctx.lineTo(j.pageX,j.pageY);this.ctx.stroke()},_drawPencilUp:function(){this.ctx.closePath()},_drawEraserDown:function(j){this.ctx.save();this.ctx.globalCompositeOperation="destination-out";this._drawPencilDown(j)},_drawEraserMove:function(j){this._drawPencilMove(j)},_drawEraserUp:function(j){this._drawPencilUp(j);this.ctx.restore()}};function g(j,p,m,n,k,o,l){this.x=j;this.y=p;this.size=m;this.inkAmount=n;this.splashRange=k;this.splashInkSize=o;this.color=l;this.resetTip();this._drops=[]}g.prototype={isStroke:false,_latest:null,_strokeRenderCount:0,_dropCount:0,_hairs:null,_latestStrokeLength:0,dist:null,dx:null,dy:null,update:function(k,j){if(!this._latest){this._latest={x:k,y:j}}else{this._latest.x=this.x;this._latest.y=this.y}this.x=k;this.y=j;this.dx=this.x-this._latest.x;this.dy=this.y-this._latest.y;this.dist=this._latestStrokeLength=Math.sqrt(this.dx*this.dx+this.dy*this.dy)},startStroke:function(k,j){this.x=k.pageX;this.y=k.pageY;e.extend(true,this,{},j);if(this.mode=="ink"){this.size=this.inkAmount=this.defaultBrushSize;if(this.size>4){this.maxBrushSize=this.defaultBrushSize*2;this.minBrushSize=this.defaultBrushSize/2}else{this.maxBrushSize=this.defaultBrushSize*1.2;this.minBrushSize=this.defaultBrushSize/1.1}console.dir(this)}this.resetTip();this._dropCount=d(6,3)|0;this.isStroke=true},endStroke:function(){this.isStroke=false;this._strokeRenderCount=0;this._dropCount=0;this._latest=null},resetTip:function(){var A=this._hairs=[];var p=this.inkAmount;var C=this.size*2;var s=this.size/2;var l,k,q,m,z;var t=d(Math.PI*2),o,B,v,u;for(var n=0,j;n<C;n++){l=d(s);k=l/2;q=d(Math.PI*2);m=l*Math.sin(q);z=k*Math.cos(q);o=Math.cos(t);B=Math.sin(t);v=this.x+m*o-z*B;u=this.y+m*B+z*o;A[n]=new f(v,u,10,p)}},inkPaint:function(s,l,k,n){this.color=this.strokeStyle;this.size=this.inkAmount=this.defaultBrushSize;this.update(l,k);this._strokeRenderCount++;if(this._strokeRenderCount%120===0&&this._dropCount<10){this._dropCount++}var r=this._hairs;var o,p;for(o=0,p=r.length;o<p;o++){r[o].update(this.dx,this.dy,this.dist)}if(this.isStroke){var m=this.color;for(o=0,p=r.length;o<p;o++){r[o].draw(s,m)}if(this.dist>30){if(this.size>4){this.drawSplash(s,this.splashRange,this.splashInkSize)}}else{if(this.dist&&this.dist<10&&d()<0.085&&this._dropCount){this._drops.push(new i(this.x,this.y,d(this.size*0.25,this.size*0.1),m,this.strokeId));this._dropCount--}}}var q=this._drops,j;for(o=0,p=q.length;o<p;o++){j=q[o];j.update(this);j.draw(s);if(j.life<0){q.splice(o,1);p--;o--}}},crayonPaint:function(E,o,m,u){this.update(o,m);e.extend(this,{},u);this.size=this.defaultBrushSize;this.color=this.strokeStyle;var F=Math.ceil(this.size/2);var A=Math.floor(this.dist/F)+1;this.dx=this.dx/this.dist*F;this.dy=this.dy/this.dist*F;var G=1.5;var z=G*Math.min(this.inkAmount/this._latestStrokeLength*3,1);var n=Math.ceil(this.size*G);var v=this.size/2;var t,q,l={},k,B,D,C;E.save();E.fillStyle=this.color;E.beginPath();for(t=0;t<n;t++){for(q=0;q<A;q++){l.x=this._latest.x+this.dx*q;l.y=this._latest.y+this.dy*q;k=d(v);B=d(Math.PI*2);w=d(z,z/2);h=d(z,z/2);D=l.x+k*Math.sin(B)-w/2;C=l.y+k*Math.cos(B)-h/2;E.rect(D,C,w,h)}}E.fill();E.restore()},resetCrayon:function(){this._latest=null},removeDrop:function(){this._drops=[]},drawSplash:function(s,m,q){var l=d(12,0);var n,j,p,o;s.save();for(var k=0;k<l;k++){j=d(m,1);n=d(Math.PI*2);p=this.x+j*Math.sin(n);o=this.y+j*Math.cos(n);b(s,p,o,this.color.toString(),d(q,0))}s.restore()}};function f(k,m,j,l){this.x=k||0;this.y=m||0;this.lineWidth=j;this.inkAmount=l;this._currentLineWidth=this.lineWidth;this._latest={x:this.x,y:this.y}}f.prototype={update:function(m,l,k){this._latest.x=this.x;this._latest.y=this.y;this.x+=m;this.y+=l;var j=Math.min(this.inkAmount/k,1);this._currentLineWidth=this.lineWidth*j},draw:function(j,k){j.save();j.lineCap="round";a(j,this._latest,this,k,this._currentLineWidth);j.restore()}};function i(j,n,m,k,l){this.x=j||0;this.y=n||0;this.amount=d(m,m*0.5);this.life=this.amount*1.5;this.color=k;this.strokeId=l;this._latest={x:this.x,y:this.y}}i.prototype={_xrate:0,update:function(l){var k=l.x-this.x;var j=l.y-this.y;if(l.size*0.3>Math.sqrt(k*k+j*j)&&l.strokeId!==this.strokeId){this.life=0;return}this._latest.x=this.x;this._latest.y=this.y;this.y+=d(this.life*0.5);this.x+=this.life*this._xrate;this.life-=d(0.05,0.01);if(d()<0.03){this._xrate+=d(0.03,-0.03)}else{if(d()<0.05){this._xrate*=0.01}}},draw:function(j){j.save();j.lineCap=j.lineJoin="round";a(j,this._latest,this,this.color,this.amount+this.life*0.3);j.restore()}};function a(k,n,m,l,j){k.strokeStyle=l;k.lineWidth=j;k.beginPath();k.moveTo(n.x,n.y);k.lineTo(m.x,m.y);k.stroke()}function b(k,j,n,l,m){k.fillStyle=l;k.beginPath();k.arc(j,n,m/2,0,Math.PI*2,false);k.fill()}function d(j,k){if(typeof j!=="number"){return Math.random()}else{if(typeof k!=="number"){k=0}}return Math.random()*(j-k)+k}})(jQuery);(function(a){if(!String.prototype.capitalize){String.prototype.capitalize=function(){return this.slice(0,1).toUpperCase()+this.slice(1)}}if(!String.prototype.inspectColor){String.prototype.inspectColor=function(){var b=document.createElement("span");b.setAttribute("style","color:"+this);return !(b.style.color=="")}}})(jQuery);